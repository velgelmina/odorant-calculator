<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—á–µ—Ç –æ–¥–æ—Ä–∞–Ω—Ç–∞ –ì–†–°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            border-radius: 5px;
        }
        
        .info-box strong {
            color: #1976D2;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        
        label .hint {
            font-weight: normal;
            color: #999;
            font-size: 12px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-save {
            background: #4CAF50;
            color: white;
        }
        
        .btn-save:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-save:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-settings {
            background: #ff9800;
            color: white;
            font-size: 14px;
            padding: 10px;
        }
        
        .btn-view-data {
            background: #2196F3;
            color: white;
            font-size: 14px;
            padding: 10px;
        }
        
        .result {
            background: #f0f7ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .result.show {
            display: block;
            animation: slideIn 0.5s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-value {
            font-size: 36px;
            color: #667eea;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .result-label {
            color: #555;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .result-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            text-align: left;
        }
        
        .result-details .row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .result-details .row:last-child {
            border-bottom: none;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
            font-size: 14px;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .setup-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .setup-section.configured {
            background: #d4edda;
            border-color: #4CAF50;
        }
        
        .setup-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .setup-section.configured .setup-title {
            color: #155724;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #667eea;
        }
        
        .loading.show {
            display: block;
        }
        
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .settings-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .instruction-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            margin: 10px 0;
        }

        .grs-input-group {
            display: flex;
            gap: 10px;
        }

        .grs-input-group select {
            flex: 2;
        }

        .grs-input-group input {
            flex: 1;
        }

        .add-grs-btn {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° –†–∞—Å—á–µ—Ç –æ–¥–æ—Ä–∞–Ω—Ç–∞</h1>
        <div class="subtitle">–¥–ª—è –ì–†–°</div>
        
        <div class="info-box">
            <strong>üìã –ú–µ—Ç–æ–¥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:</strong><br>
            –ü–æ –°–¢ –ê–û 970740000392-49-2025<br>
            –ù–æ—Ä–º–∞ –æ–¥–æ—Ä–∏–∑–∞—Ü–∏–∏: 16 –≥/1000–º¬≥
        </div>
        
        <div id="setupSection" class="setup-section">
            <div class="setup-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</div>
            <button class="btn btn-settings" onclick="openSettings()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
        </div>
        
        <div class="form-group">
            <label for="grsName">
                –ù–∞–∑–≤–∞–Ω–∏–µ –ì–†–°:
            </label>
            <div class="grs-input-group">
                <select id="grsName" onchange="handleGrsSelect()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ì–†–°</option>
                    <option value="new">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ì–†–°</option>
                </select>
                <input type="text" id="newGrsName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" style="display: none;">
            </div>
        </div>
        
        <div class="form-group">
            <label for="operator">–û–ø–µ—Ä–∞—Ç–æ—Ä (—Å–º–µ–Ω–∞):</label>
            <select id="operator">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É</option>
                <option value="–°–º–µ–Ω–∞ 1">–°–º–µ–Ω–∞ 1</option>
                <option value="–°–º–µ–Ω–∞ 2">–°–º–µ–Ω–∞ 2</option>
                <option value="–°–º–µ–Ω–∞ 3">–°–º–µ–Ω–∞ 3</option>
                <option value="–°–º–µ–Ω–∞ 4">–°–º–µ–Ω–∞ 4</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="dailyFlow">
                –°—É—Ç–æ—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –≥–∞–∑–∞ (Q—Å—É—Ç):
                <span class="hint">–º¬≥/—Å—É—Ç</span>
            </label>
            <input type="number" id="dailyFlow" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥ –≥–∞–∑–∞ –∑–∞ —Å—É—Ç–∫–∏" step="0.01">
        </div>
        
        <div class="form-group">
            <label for="sulfurInGas">
                –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã –≤ –≥–∞–∑–µ (S):
                <span class="hint">–≥/1000–º¬≥ (–∏–∑ —Ö–∏–º–∞–Ω–∞–ª–∏–∑–∞)</span>
            </label>
            <input type="number" id="sulfurInGas" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –º–µ—Ä–∫–∞–ø—Ç–∞–Ω–æ–≤–æ–π —Å–µ—Ä—ã" step="0.01">
        </div>
        
        <button class="btn btn-calculate" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        
        <div id="result" class="result">
            <div class="result-label">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Ä–∞—Å—Ö–æ–¥ –æ–¥–æ—Ä–∞–Ω—Ç–∞:</div>
            <div class="result-value" id="resultValue">0</div>
            
            <div class="result-details" id="resultDetails">
                <div class="row">
                    <span>–ß–∞—Å–æ–≤–æ–π —Ä–∞—Å—Ö–æ–¥ –≥–∞–∑–∞:</span>
                    <strong id="hourlyFlow">-</strong>
                </div>
                <div class="row">
                    <span>–†–∞—Å—Ö–æ–¥ –æ–¥–æ—Ä–∞–Ω—Ç–∞ (—á–∞—Å):</span>
                    <strong id="hourlyOdorant">-</strong>
                </div>
                <div class="row">
                    <span>–†–∞—Å—Ö–æ–¥ –æ–¥–æ—Ä–∞–Ω—Ç–∞ (–º–∏–Ω):</span>
                    <strong id="minuteOdorant">-</strong>
                </div>
                <div class="row">
                    <span>–ö–∞–ø–µ–ª—å –≤ –º–∏–Ω—É—Ç—É:</span>
                    <strong id="dropsPerMinute">-</strong>
                </div>
            </div>
            
            <button class="btn btn-save" onclick="saveData()" id="saveBtn">‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
        
        <div id="loading" class="loading">‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</div>
        <div id="message" class="message"></div>
        
        <button class="btn btn-view-data" onclick="openSheet()">üìä –û—Ç–∫—Ä—ã—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å –¥–∞–Ω–Ω—ã–º–∏</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button class="close-btn" onclick="closeSettings()">‚úï</button>
            </div>
            
            <div class="instruction-box">
                <strong>üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞</strong><br><br>
                –£–∫–∞–∂–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –º–µ—Ä–∫–∞–ø—Ç–∞–Ω–æ–≤–æ–π —Å–µ—Ä—ã –≤ –æ–¥–æ—Ä–∞–Ω—Ç–µ (–∏–∑ –ø–∞—Å–ø–æ—Ä—Ç–∞ –Ω–∞ –ø–∞—Ä—Ç–∏—é –æ–¥–æ—Ä–∞–Ω—Ç–∞).<br><br>
                –¢–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: 0,37 –∏–ª–∏ 0,41 –≥/–º¬≥
            </div>
            
            <div class="form-group">
                <label for="sulfurInOdorant">
                    –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã –≤ –æ–¥–æ—Ä–∞–Ω—Ç–µ (f):
                    <span class="hint">–≥/–º¬≥ (–∏–∑ –ø–∞—Å–ø–æ—Ä—Ç–∞)</span>
                </label>
                <input type="number" id="sulfurInOdorant" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 0.37" step="0.01" min="0.1" max="1.0">
            </div>

            <div class="instruction-box">
                <strong>‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (Google Sheets)</strong><br><br>
                                
            </div>
            
            <div class="form-group">
                <label for="scriptUrl">URL Apps Script:</label>
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/...">
            </div>
            
            <div class="form-group">
                <label for="sheetUrl">URL Google –¢–∞–±–ª–∏—Ü—ã:</label>
                <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
            </div>
            
            <button class="btn btn-save" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const NORM = 16; // –ù–æ—Ä–º–∞ –æ–¥–æ—Ä–∏–∑–∞—Ü–∏–∏ –≥/1000–º¬≥
        const DROP_WEIGHT = 0.03244; // –í–µ—Å –æ–¥–Ω–æ–π –∫–∞–ø–ª–∏, –≥
        const DROP_VOLUME = 0.04; // –û–±—ä–µ–º –æ–¥–Ω–æ–π –∫–∞–ø–ª–∏, –º–ª

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = function() {
            loadSettings();
            loadGrsList();
        };

        function loadSettings() {
            const sulfurInOdorant = localStorage.getItem('sulfurInOdorant');
            const scriptUrl = localStorage.getItem('scriptUrl');
            const sheetUrl = localStorage.getItem('sheetUrl');
            
            if (sulfurInOdorant) {
                document.getElementById('setupSection').classList.add('configured');
                document.querySelector('.setup-title').textContent = '‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (f = ' + sulfurInOdorant + ' –≥/–º¬≥)';
            }
        }

        function loadGrsList() {
            const grsList = JSON.parse(localStorage.getItem('grsList') || '[]');
            const select = document.getElementById('grsName');
            
            // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
            while (select.options.length > 2) {
                select.remove(2);
            }
            
            grsList.forEach(grs => {
                const option = document.createElement('option');
                option.value = grs;
                option.textContent = grs;
                select.appendChild(option);
            });
        }

        function handleGrsSelect() {
            const select = document.getElementById('grsName');
            const newInput = document.getElementById('newGrsName');
            
            if (select.value === 'new') {
                newInput.style.display = 'block';
                newInput.focus();
            } else {
                newInput.style.display = 'none';
                newInput.value = '';
            }
        }

        function getGrsName() {
            const select = document.getElementById('grsName');
            const newInput = document.getElementById('newGrsName');
            
            if (select.value === 'new') {
                const newGrsName = newInput.value.trim();
                if (newGrsName) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
                    const grsList = JSON.parse(localStorage.getItem('grsList') || '[]');
                    if (!grsList.includes(newGrsName)) {
                        grsList.push(newGrsName);
                        localStorage.setItem('grsList', JSON.stringify(grsList));
                        loadGrsList();
                    }
                    return newGrsName;
                }
                return '';
            }
            return select.value;
        }
        
        function calculate() {
            const grsName = getGrsName();
            const operator = document.getElementById('operator').value;
            const dailyFlow = parseFloat(document.getElementById('dailyFlow').value);
            const sulfurInGas = parseFloat(document.getElementById('sulfurInGas').value);
            const sulfurInOdorant = parseFloat(localStorage.getItem('sulfurInOdorant'));
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (!sulfurInOdorant) {
                showMessage('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã –≤ –æ–¥–æ—Ä–∞–Ω—Ç–µ!', 'error');
                openSettings();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π
            if (!grsName) {
                showMessage('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ì–†–°!', 'error');
                return;
            }
            
            if (!operator) {
                showMessage('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞!', 'error');
                return;
            }
            
            if (!dailyFlow || dailyFlow <= 0) {
                showMessage('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É—Ç–æ—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –≥–∞–∑–∞!', 'error');
                return;
            }
            
            if (sulfurInGas < 0 || sulfurInGas >= NORM) {
                showMessage('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã –≤ –≥–∞–∑–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 0 –¥–æ 16)!', 'error');
                return;
            }
            
            // –†–ê–°–ß–ï–¢ –ü–û –§–û–†–ú–£–õ–ê–ú
            // 1. –ß–∞—Å–æ–≤–æ–π —Ä–∞—Å—Ö–æ–¥ –≥–∞–∑–∞ (—Ñ–æ—Ä–º—É–ª–∞ 16)
            const hourlyFlow = dailyFlow / 24;
            
            // 2. –ß–∞—Å–æ–≤–æ–π —Ä–∞—Å—Ö–æ–¥ –æ–¥–æ—Ä–∞–Ω—Ç–∞ (—Ñ–æ—Ä–º—É–ª–∞ 17)
            const hourlyOdorant = (hourlyFlow * (NORM - sulfurInGas)) / (1000 * sulfurInOdorant);
            
            // 3. –ú–∏–Ω—É—Ç–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –æ–¥–æ—Ä–∞–Ω—Ç–∞ (—Ñ–æ—Ä–º—É–ª–∞ 18)
            const minuteOdorant = hourlyOdorant / 60;
            
            // 4. –ö–∞–ø–µ–ª—å –≤ –º–∏–Ω—É—Ç—É (—Ñ–æ—Ä–º—É–ª–∞ 19)
            const dropsPerMinute = minuteOdorant / DROP_WEIGHT;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞
            let resultText = '';
            let resultValue = '';
            
            if (dropsPerMinute < 60) {
                // –§–æ—Ä–º—É–ª–∞ 20 - —Å–µ–∫—É–Ω–¥ –Ω–∞ –∫–∞–ø–ª—é
                const secondsPerDrop = 60 / dropsPerMinute;
                resultValue = secondsPerDrop.toFixed(1) + ' —Å–µ–∫';
                resultText = '1 –∫–∞–ø–ª—è –∫–∞–∂–¥—ã–µ ' + secondsPerDrop.toFixed(1) + ' —Å–µ–∫—É–Ω–¥';
            } else if (dropsPerMinute >= 60 && dropsPerMinute <= 180) {
                // –ö–∞–ø–µ–ª—å –≤ –º–∏–Ω—É—Ç—É
                resultValue = dropsPerMinute.toFixed(1) + ' –∫–∞–ø/–º–∏–Ω';
                resultText = dropsPerMinute.toFixed(1) + ' –∫–∞–ø–µ–ª—å –≤ –º–∏–Ω—É—Ç—É';
            } else {
                // –§–æ—Ä–º—É–ª–∞ 22 - –º–ª –≤ –º–∏–Ω—É—Ç—É
                const mlPerMinute = dropsPerMinute * DROP_VOLUME;
                resultValue = mlPerMinute.toFixed(1) + ' –º–ª/–º–∏–Ω';
                resultText = mlPerMinute.toFixed(1) + ' –º–∏–ª–ª–∏–ª–∏—Ç—Ä–æ–≤ –≤ –º–∏–Ω—É—Ç—É';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('resultValue').textContent = resultText;
            document.getElementById('hourlyFlow').textContent = hourlyFlow.toFixed(2) + ' –º¬≥/—á';
            document.getElementById('hourlyOdorant').textContent = hourlyOdorant.toFixed(2) + ' –≥/—á';
            document.getElementById('minuteOdorant').textContent = minuteOdorant.toFixed(4) + ' –≥/–º–∏–Ω';
            document.getElementById('dropsPerMinute').textContent = dropsPerMinute.toFixed(2);
            
            document.getElementById('result').classList.add('show');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∑–∞–ø–∏—Å–∏
            window.currentCalculation = {
                grsName: grsName,
                operator: operator,
                dailyFlow: dailyFlow,
                sulfurInGas: sulfurInGas,
                sulfurInOdorant: sulfurInOdorant,
                hourlyFlow: hourlyFlow.toFixed(2),
                hourlyOdorant: hourlyOdorant.toFixed(2),
                minuteOdorant: minuteOdorant.toFixed(4),
                dropsPerMinute: dropsPerMinute.toFixed(2),
                result: resultValue,
                resultText: resultText,
                timestamp: new Date().toLocaleString('ru-RU')
            };
            
            hideMessage();
        }
        
        async function saveData() {
            const scriptUrl = localStorage.getItem('scriptUrl');
            
            if (!scriptUrl) {
                showMessage('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ!', 'error');
                openSettings();
                return;
            }
            
            if (!window.currentCalculation) {
                showMessage('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç!', 'error');
                return;
            }
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(window.currentCalculation)
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
                let localData = JSON.parse(localStorage.getItem('odorantData') || '[]');
                localData.push(window.currentCalculation);
                localStorage.setItem('odorantData', JSON.stringify(localData));
                
                showMessage('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ!', 'success');
                
                document.getElementById('dailyFlow').value = '';
                document.getElementById('sulfurInGas').value = '';
                document.getElementById('result').classList.remove('show');
                window.currentCalculation = null;
                
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            
            const sulfurInOdorant = localStorage.getItem('sulfurInOdorant') || '';
            const scriptUrl = localStorage.getItem('scriptUrl') || '';
            const sheetUrl = localStorage.getItem('sheetUrl') || '';
            
            document.getElementById('sulfurInOdorant').value = sulfurInOdorant;
            document.getElementById('scriptUrl').value = scriptUrl;
            document.getElementById('sheetUrl').value = sheetUrl;
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        function saveSettings() {
            const sulfurInOdorant = parseFloat(document.getElementById('sulfurInOdorant').value);
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            const sheetUrl = document.getElementById('sheetUrl').value.trim();
            
            if (!sulfurInOdorant || sulfurInOdorant <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã –≤ –æ–¥–æ—Ä–∞–Ω—Ç–µ!');
                return;
            }
            
            localStorage.setItem('sulfurInOdorant', sulfurInOdorant);
            localStorage.setItem('scriptUrl', scriptUrl);
            localStorage.setItem('sheetUrl', sheetUrl);
            
            document.getElementById('setupSection').classList.add('configured');
            document.querySelector('.setup-title').textContent = '‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (f = ' + sulfurInOdorant + ' –≥/–º¬≥)';
            
            closeSettings();
            showMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
        }
        
        function openSheet() {
            const sheetUrl = localStorage.getItem('sheetUrl');
            if (!sheetUrl) {
                showMessage('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Google –¢–∞–±–ª–∏—Ü—É!', 'error');
                openSettings();
                return;
            }
            window.open(sheetUrl, '_blank');
        }
        
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message ' + type;
            setTimeout(hideMessage, 4000);
        }
        
        function hideMessage() {
            document.getElementById('message').className = 'message';
        }
    </script>
</body>
</html>
